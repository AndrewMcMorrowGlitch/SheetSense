<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1220;             /* deep slate */
      --bg-soft: #0e1628;         /* softer panel bg */
      --panel: rgba(255,255,255,0.06);
      --panel-solid: #0f172a;
      --text: #e5e7eb;            /* gray-200 */
      --muted: #94a3b8;           /* slate-400 */
      --border: rgba(148,163,184,0.18);
      --primary: #22d3ee;         /* cyan-400 */
      --primary-600: #06b6d4;     /* cyan-500 */
      --accent: #a78bfa;          /* violet-400 */
      --danger: #f43f5e;          /* rose-500 */
      --success: #22c55e;         /* green-500 */
      --shadow: 0 8px 24px rgba(2, 6, 23, 0.45);
      --glow: 0 0 0 1px rgba(34,211,238,0.25), 0 8px 28px rgba(34,211,238,0.15);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      background:
        radial-gradient(1200px 500px at 80% -10%, rgba(167,139,250,0.2), transparent 50%),
        radial-gradient(1000px 600px at -10% 110%, rgba(34,211,238,0.18), transparent 40%),
        var(--bg);
      color: var(--text);
      letter-spacing: -0.01em;
      overflow: hidden; /* prevent body scroll; we scroll the chat container */
      position: relative;
    }

    /* Absolute wrapper avoids quirky vh behavior inside Sheets sidebar iframe */
    .layout {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      min-height: 0; /* allow children with overflow to size correctly */
    }

    .header {
      background: linear-gradient(180deg, rgba(15,23,42,0.9), rgba(15,23,42,0.6));
      color: white;
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      position: relative;
      overflow: hidden;
    }
    .header::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(600px 120px at -10% -40%, rgba(167,139,250,0.22), transparent 60%);
      pointer-events: none;
    }

    .brand {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tag {
      font-size: 10px;
      font-weight: 600;
      color: #0b1220;
      background: linear-gradient(180deg, #a5b4fc, #818cf8);
      padding: 2px 6px;
      border-radius: 999px;
      transform: translateY(-1px);
    }

    .subline {
      margin: 6px 0 0 18px;
      font-size: 12px;
      opacity: 0.8;
      font-weight: 400;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, var(--primary));
      box-shadow: 0 0 0 2px rgba(34,211,238,0.15), 0 0 12px rgba(34,211,238,0.35);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.6} }

    .suggestions {
      position: relative;
      padding: 10px 12px 12px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid var(--border);
      backdrop-filter: saturate(140%) blur(8px);
      max-height: 120px;
      transition: max-height .25s ease, opacity .2s ease, padding .25s ease, border-width .25s ease;
    }
    .suggestions.collapsed { max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; border-bottom-width: 0; overflow: hidden; }
    .suggestions strong {
      display: block;
      margin: 0 0 8px 2px;
      color: #cbd5e1;
      font-weight: 500;
      font-size: 11px;
      letter-spacing: 0.02em;
    }
    .suggestion-list {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 2px 2px 6px;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x proximity;
      scrollbar-width: thin;                                 /* Firefox */
      scrollbar-color: rgba(255,255,255,0.28) transparent;   /* Firefox */
    }
    .suggestion-list::-webkit-scrollbar { height: 6px; }
    .suggestion-list::-webkit-scrollbar-track {
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      border-radius: 9999px;
    }
    .suggestion-list::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.28);
      border-radius: 9999px;
      border: 1px solid rgba(148,163,184,0.25);
    }
    .suggestion-list::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }
    .suggestions .edge {
      position: absolute; top: 0; bottom: 0; width: 24px; pointer-events: none; transition: opacity .2s ease;
    }
    .suggestions .edge-left { left: 0; background: linear-gradient(90deg, rgba(11,18,32,0.95), rgba(11,18,32,0)); }
    .suggestions .edge-right { right: 0; background: linear-gradient(270deg, rgba(11,18,32,0.95), rgba(11,18,32,0)); }
    .suggestions.at-start .edge-left { opacity: 0; }
    .suggestions.at-end .edge-right { opacity: 0; }
    .chip {
      flex: 0 0 auto;
      padding: 7px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border: 1px solid var(--border);
      border-radius: 9999px;
      font-size: 12px;
      color: #e5e7eb;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s;
      white-space: nowrap;
      user-select: none;
      box-shadow: 0 1px 0 rgba(255,255,255,0.05) inset;
    }
    .chip:hover { border-color: rgba(34,211,238,0.35); box-shadow: var(--glow); transform: translateY(-1px); }
    .chip .chip-icon { display:inline-flex; align-items:center; margin-right: 6px; opacity: .85; }

    .chat-container {
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
      padding: 14px 12px 88px; /* leave space for floating dock */
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      position: relative;
      padding: 12px;
      border-radius: 14px;
      max-width: 88%;
      line-height: 1.6;
      font-size: 13px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }
    .message .actions {
      position: absolute;
      top: 6px;
      right: 6px;
      opacity: 0;
      transform: translateY(-2px);
      transition: opacity .15s ease, transform .15s ease;
      display: flex; gap: 6px;
    }
    .message:hover .actions { opacity: 1; transform: translateY(0); }
    .icon-btn {
      width: 22px; height: 22px;
      display: inline-flex; align-items: center; justify-content: center;
      border-radius: 6px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      cursor: pointer; color: #cbd5e1;
    }
    .icon-btn:hover { border-color: rgba(34,211,238,0.35); color: white; box-shadow: var(--glow); }

    .message.user {
      background: linear-gradient(180deg, rgba(34,211,238,0.2), rgba(34,211,238,0.08));
      color: #ecfeff;
      border-color: rgba(34,211,238,0.35);
      align-self: flex-end;
    }
    .message.agent { align-self: flex-start; }
    .message.error {
      background-color: #fef2f2;
      color: #991b1b;
      align-self: flex-start;
      border-left: 3px solid #dc2626;
    }
    .message.success {
      background-color: #f0fdf4;
      color: #166534;
      align-self: flex-start;
      border-left: 3px solid var(--primary);
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      vertical-align: baseline;
    }
    .badge-success { background: rgba(22,101,52,0.18); color: #86efac; border: 1px solid rgba(134,239,172,0.25); }
    .badge-error { background: rgba(190,18,60,0.18); color: #fecdd3; border: 1px solid rgba(254,205,211,0.25); }

    .loading {
      position: sticky; bottom: 76px; /* sit above dock */
      display: none;
      text-align: center;
      padding: 8px 12px;
      color: #cbd5e1;
      font-size: 12px;
    }
    .loading.active { display: flex; align-items: center; justify-content: center; gap: 8px; }
    .spinner { width: 14px; height: 14px; border: 2px solid rgba(148,163,184,0.3); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .dock {
      position: absolute; left: 12px; right: 12px; bottom: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      border: 1px solid var(--border);
      border-radius: 14px;
      display: flex; gap: 8px; align-items: center;
      padding: 10px 10px 10px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: saturate(140%) blur(10px);
    }
    #commandInput {
      flex: 1;
      padding: 10px 12px;
      border: 0;
      color: var(--text);
      background: transparent;
      font-size: 13px;
      outline: none;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .circle-btn {
      width: 34px; height: 34px; border-radius: 999px;
      display: inline-flex; align-items: center; justify-content: center;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      color: #e2e8f0; cursor: pointer;
      transition: transform .12s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .circle-btn:hover { transform: translateY(-1px); box-shadow: var(--glow); border-color: rgba(34,211,238,0.35); }
    .circle-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .welcome-message {
      text-align: center;
      padding: 20px 12px 8px;
      color: var(--muted);
    }
    .welcome-message h3 {
      margin: 0 0 8px 0;
      color: #0a0a0a;
      font-weight: 600;
      font-size: 15px;
      letter-spacing: -0.01em;
    }

    pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 6px;
      overflow: auto;
      font-size: 12px;
      border: 1px solid var(--border);
      max-width: 100%;
    }
  </style>
</head>
<body>
  <div class="layout">
    <div class="header">
      <div class="brand">
        <span class="status-indicator"></span>
        SheetSense
        <span class="tag">AI</span>
      </div>
      <p class="subline">Natural language spreadsheet copilot</p>
      <div style="position:absolute; top:10px; right:10px; display:flex; gap:6px;">
        <button class="icon-btn" aria-label="Clear chat" title="Clear chat" onclick="clearChat()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
        </button>
      </div>
    </div>

    <div class="suggestions">
      <strong>Try these commands:</strong>
      <div class="suggestion-list">
        <div class="chip" onclick="insertSuggestionText('Show me the data in A1:E5')">
          <span class="chip-icon">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l1.9 5.8L20 9l-5 3.8L16 20l-4-3-4 3 1-7.2L4 9l6.1-1.2L12 2z"/></svg>
          </span>
          Show me the data in A1:E5
        </div>
        <div class="chip" onclick="insertSuggestionText(`Put 'Hello' in cell A1`)">
          <span class="chip-icon">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6"/><path d="M6 20V10"/><path d="M18 20v-4"/></svg>
          </span>
          Put 'Hello' in cell A1
        </div>
        <div class="chip" onclick="insertSuggestionText('List all tabs')">
          <span class="chip-icon">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M3 10h18"/></svg>
          </span>
          List all tabs
        </div>
      </div>
      <div class="edge edge-left"></div>
      <div class="edge edge-right"></div>
    </div>

    <div class="chat-container" id="chatContainer">
      <div class="welcome-message">
        <h3>Welcome to SheetSense!</h3>
        <p>Ask me anything about your spreadsheet in natural language.</p>
      </div>
    </div>

    <div class="loading" id="loading"><span class="spinner"></span> Agent is thinking</div>
    <div class="dock">
      <input
        type="text"
        id="commandInput"
        placeholder="Ask SheetSense to do somethingâ€¦"
        onkeypress="handleKeyPress(event)"
        autocomplete="off"
      >
      <button class="circle-btn" id="sendBtn" onclick="sendCommand()" aria-label="Send" title="Send">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
      </button>
    </div>
  </div>

  <script>
    const chatContainer = document.getElementById('chatContainer');
    const commandInput = document.getElementById('commandInput');
    const sendBtn = document.getElementById('sendBtn');
    const loading = document.getElementById('loading');
    const suggestionsWrap = document.querySelector('.suggestions');
    const suggestionsList = document.querySelector('.suggestion-list');

    function insertSuggestionText(text) {
      commandInput.value = text;
      commandInput.focus();
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendCommand();
      }
    }

    function addMessage(text, type = 'agent') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      const actions = document.createElement('div');
      actions.className = 'actions';
      actions.innerHTML = `
        <button class="icon-btn" aria-label="Copy message" title="Copy message" onclick="copyMessage(this)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        </button>`;

      // Simple formatting
      const formattedText = String(text)
        .replace(/\[SUCCESS\]/g, '<span class="badge badge-success">SUCCESS</span>')
        .replace(/\[ERROR\]/g, '<span class="badge badge-error">ERROR</span>');

      const content = document.createElement('div');
      content.className = 'content';
      content.innerHTML = formattedText;

      messageDiv.appendChild(actions);
      messageDiv.appendChild(content);
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function copyMessage(btn) {
      const msg = btn.closest('.message');
      if (!msg) return;
      const text = msg.querySelector('.content')?.innerText || '';
      navigator.clipboard?.writeText(text).catch(function(){});
      btn.classList.add('copied');
      setTimeout(() => btn.classList.remove('copied'), 900);
    }

    function sendCommand() {
      const command = commandInput.value.trim();
      if (!command) return;

      sendBtn.disabled = true;
      commandInput.disabled = true;
      loading.classList.add('active');

      // Hide suggestions after the first user message
      collapseSuggestions();

      addMessage(command, 'user');
      commandInput.value = '';

      google.script.run
        .withSuccessHandler(handleSuccess)
        .withFailureHandler(handleError)
        .executeCommand(command);
    }

    function handleSuccess(response) {
      sendBtn.disabled = false;
      commandInput.disabled = false;
      loading.classList.remove('active');
      commandInput.focus();

      if (response && response.success) {
        addMessage(response.result ?? '');
      } else {
        addMessage((response && response.error) ? response.error : 'Unknown error', 'error');
      }
    }

    function handleError(error) {
      sendBtn.disabled = false;
      commandInput.disabled = false;
      loading.classList.remove('active');
      commandInput.focus();

      addMessage('Error: ' + (error && error.message ? error.message : 'request failed'), 'error');
    }

    window.onload = function() { commandInput.focus(); };

    // Suggestion edge fades logic
    function updateSuggestionFades() {
      if (!suggestionsWrap || !suggestionsList) return;
      const atStart = suggestionsList.scrollLeft <= 1;
      const atEnd = (suggestionsList.scrollWidth - suggestionsList.clientWidth - suggestionsList.scrollLeft) <= 1;
      suggestionsWrap.classList.toggle('at-start', atStart);
      suggestionsWrap.classList.toggle('at-end', atEnd);
    }
    suggestionsList?.addEventListener('scroll', updateSuggestionFades, { passive: true });
    window.addEventListener('resize', updateSuggestionFades);
    setTimeout(updateSuggestionFades, 0);

    function clearChat() {
      chatContainer.innerHTML = '';
      addWelcome();
      // Restore suggestions visibility on clear
      if (suggestionsWrap) {
        suggestionsWrap.classList.remove('collapsed');
        updateSuggestionFades();
      }
    }

    function addWelcome() {
      const w = document.createElement('div');
      w.className = 'welcome-message';
      w.innerHTML = '<h3>Welcome to SheetSense!</h3><p>Ask me anything about your spreadsheet in natural language.</p>';
      chatContainer.appendChild(w);
    }

    function collapseSuggestions() {
      if (suggestionsWrap && !suggestionsWrap.classList.contains('collapsed')) {
        suggestionsWrap.classList.add('collapsed');
      }
    }
  </script>
</body>
</html>
